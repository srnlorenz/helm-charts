suite: test statefulset-worker

templates:
  - configmap.yaml
  - secret.yaml
  - statefulset-worker.yaml

release:
  name: n8n
  namespace: n8n

chart:
  version: 1.0.0
  appVersion: 1.0.0

set:
  worker:
    count: 2
    mode: queue
    persistence:
      enabled: true
  db:
    type: postgresdb

tests:
  - it: should not have worker deployment when dbtype is sqlite
    set:
      db:
        type: sqlite
    asserts:
      - hasDocuments:
          count: 0
        template: statefulset-worker.yaml

  - it: should not have worker deployment when worker mode is regular
    set:
      worker:
        mode: regular
    asserts:
      - hasDocuments:
          count: 0
        template: statefulset-worker.yaml

  - it: should set replica count when worker count is set
    set:
      worker:
        count: 3
    asserts:
      - equal:
          path: spec.replicas
          value: 3
        template: statefulset-worker.yaml

  - it: should set pod annotations when podAnnotations are set
    set:
      podAnnotations:
        test: test
    asserts:
      - equal:
          path: spec.template.metadata.annotations.test
          value: test
        template: statefulset-worker.yaml

  - it: should set pod labels when podLabels are set
    set:
      podLabels:
        test: test
    asserts:
      - equal:
          path: spec.template.metadata.labels.test
          value: test
        template: statefulset-worker.yaml

  - it: should set image pull secrets when imagePullSecrets are set
    set:
      imagePullSecrets:
        - name: fake-image-pull-secret
    asserts:
      - equal:
          path: spec.template.spec.imagePullSecrets[0].name
          value: fake-image-pull-secret
        template: statefulset-worker.yaml

  - it: should be custom service account when we do not create it
    set:
      serviceAccount:
        create: false
        name: customsa
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: customsa
        template: statefulset-worker.yaml

  - it: should set pod security context when podSecurityContext is set
    set:
      podSecurityContext:
        runAsUser: 1000
        runAsGroup: 1000
        runAsNonRoot: true
    asserts:
      - equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 1000
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.securityContext.runAsGroup
          value: 1000
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.securityContext.runAsNonRoot
          value: true
        template: statefulset-worker.yaml

  - it: should set container security context when securityContext is set
    set:
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        runAsNonRoot: true
    asserts:
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].securityContext.runAsUser
          value: 1000
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].securityContext.runAsGroup
          value: 1000
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].securityContext.runAsNonRoot
          value: true
        template: statefulset-worker.yaml

  - it: should use image repository and tag from image when they set
    set:
      image:
        repository: fake-image-repository/fake-image
        tag: fake-tag
    asserts:
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].image
          value: fake-image-repository/fake-image:fake-tag
        template: statefulset-worker.yaml

  - it: should use default image and chart app version as image tag when tag is not set
    set:
      image:
        tag: ""
    release:
      name: outline
      namespace: outline
    chart:
      version: 1.0.0
      appVersion: 0.81.0
    asserts:
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].image
          value: n8nio/n8n:0.81.0
        template: statefulset-worker.yaml

  - it: should set image pull policy when imagePullPolicy is set
    set:
      image.pullPolicy: Always
    asserts:
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].imagePullPolicy
          value: Always
        template: statefulset-worker.yaml

  - it: should set command to n8n with worker arg and concurrency
    set:
      worker:
        concurrency: 10
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].command
          content:
            n8n
        template: statefulset-worker.yaml
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].args
          content: worker
        template: statefulset-worker.yaml
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].args
          content: "--concurrency=10"
        template: statefulset-worker.yaml

  - it: should set ports when service.port is set
    set:
      service:
        port: 8080
        name: fake-port
    asserts:
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].ports[0].name
          value: fake-port
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].ports[0].containerPort
          value: 8080
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].ports[0].protocol
          value: TCP
        template: statefulset-worker.yaml

  - it: should set startup probe when worker.startupProbe is set
    set:
      worker:
        startupProbe:
          exec:
            command: ["/bin/sh", "-c", "ps aux | grep '[n]8n'"]
          initialDelaySeconds: 10
          periodSeconds: 5
          failureThreshold: 30
          timeoutSeconds: 5
          successThreshold: 1
    asserts:
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].startupProbe.exec.command[0]
          value: /bin/sh
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].startupProbe.exec.command[1]
          value: -c
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].startupProbe.exec.command[2]
          value: ps aux | grep '[n]8n'
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].startupProbe.initialDelaySeconds
          value: 10
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].startupProbe.periodSeconds
          value: 5
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].startupProbe.timeoutSeconds
          value: 5
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].startupProbe.failureThreshold
          value: 30
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].startupProbe.successThreshold
          value: 1
        template: statefulset-worker.yaml

  - it: should set liveness probe when livenessProbe is set
    set:
      livenessProbe:
        httpGet:
          path: /healthz
          port: http
        initialDelaySeconds: 10
        periodSeconds: 10
        timeoutSeconds: 5
        failureThreshold: 3
        successThreshold: 1
    asserts:
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].livenessProbe.httpGet.path
          value: /healthz
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].livenessProbe.httpGet.port
          value: http
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].livenessProbe.initialDelaySeconds
          value: 10
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].livenessProbe.periodSeconds
          value: 10
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].livenessProbe.timeoutSeconds
          value: 5
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].livenessProbe.failureThreshold
          value: 3
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].livenessProbe.successThreshold
          value: 1
        template: statefulset-worker.yaml

  - it: should set liveness probe when worker.livenessProbe is set
    set:
      worker:
        livenessProbe:
          httpGet:
            path: /healthz
            port: http
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
          successThreshold: 1
    asserts:
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].livenessProbe.httpGet.path
          value: /healthz
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].livenessProbe.httpGet.port
          value: http
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].livenessProbe.initialDelaySeconds
          value: 10
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].livenessProbe.periodSeconds
          value: 10
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].livenessProbe.timeoutSeconds
          value: 5
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].livenessProbe.failureThreshold
          value: 3
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].livenessProbe.successThreshold
          value: 1
        template: statefulset-worker.yaml

  - it: should set readiness probe when readinessProbe is set
    set:
      readinessProbe:
        httpGet:
          path: /healthz/readiness
          port: http
        initialDelaySeconds: 10
        periodSeconds: 10
        timeoutSeconds: 5
        failureThreshold: 3
        successThreshold: 1
    asserts:
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].readinessProbe.httpGet.path
          value: /healthz/readiness
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].readinessProbe.httpGet.port
          value: http
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].readinessProbe.initialDelaySeconds
          value: 10
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].readinessProbe.periodSeconds
          value: 10
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].readinessProbe.timeoutSeconds
          value: 5
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].readinessProbe.failureThreshold
          value: 3
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].readinessProbe.successThreshold
          value: 1
        template: statefulset-worker.yaml

  - it: should set readiness probe when worker.readinessProbe is set
    set:
      worker:
        readinessProbe:
          httpGet:
            path: /healthz/readiness
            port: http
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
          successThreshold: 1
    asserts:
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].readinessProbe.httpGet.path
          value: /healthz/readiness
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].readinessProbe.httpGet.port
          value: http
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].readinessProbe.initialDelaySeconds
          value: 10
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].readinessProbe.periodSeconds
          value: 10
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].readinessProbe.timeoutSeconds
          value: 5
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].readinessProbe.failureThreshold
          value: 3
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].readinessProbe.successThreshold
          value: 1
        template: statefulset-worker.yaml

  - it: should set resources when resources are set
    set:
      resources:
        requests:
          cpu: 100m
          memory: 100Mi
        limits:
          cpu: 200m
          memory: 200Mi
    asserts:
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].resources.requests.cpu
          value: 100m
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].resources.requests.memory
          value: 100Mi
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].resources.limits.cpu
          value: 200m
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].resources.limits.memory
          value: 200Mi
        template: statefulset-worker.yaml

  - it: should set resources when worker.resources are set
    set:
      worker:
        resources:
          requests:
            cpu: 100m
            memory: 100Mi
          limits:
            cpu: 200m
            memory: 200Mi
    asserts:
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].resources.requests.cpu
          value: 100m
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].resources.requests.memory
          value: 100Mi
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].resources.limits.cpu
          value: 200m
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].resources.limits.memory
          value: 200Mi
        template: statefulset-worker.yaml

  - it: should set hiring banner disabled
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].env
          content:
            name: N8N_HIRING_BANNER_ENABLED
            value: "false"
        template: statefulset-worker.yaml

  - it: should set node environment to production
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].env
          content:
            name: NODE_ENV
            value: production
        template: statefulset-worker.yaml

  - it: should set enforce settings file permissions
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].env
          content:
            name: N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS
            value: "true"
        template: statefulset-worker.yaml

  - it: should set port environment variable when service.port is set
    set:
      service:
        port: 8080
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].env
          content:
            name: N8N_PORT
            value: "8080"
        template: statefulset-worker.yaml

  - it: should set default locale environment variable when defaultLocale is set
    set:
      defaultLocale: de
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].env
          content:
            name: N8N_DEFAULT_LOCALE
            value: de
        template: statefulset-worker.yaml

  - it: should set timezone environment variable when timezone is set
    set:
      timezone: America/New_York
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].env
          content:
            name: GENERIC_TIMEZONE
            value: America/New_York
        template: statefulset-worker.yaml

  - it: should set graceful shutdown timeout environment variable when gracefulShutdownTimeout is set
    set:
      gracefulShutdownTimeout: 10
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].env
          content:
            name: N8N_GRACEFUL_SHUTDOWN_TIMEOUT
            value: "10"
        template: statefulset-worker.yaml

  - it: should disable ui for the worker
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].env
          content:
            name: N8N_DISABLE_UI
            value: "true"
        template: statefulset-worker.yaml

  - it: should set queue health check active environment variable
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].env
          content:
            name: QUEUE_HEALTH_CHECK_ACTIVE
            value: "true"
        template: statefulset-worker.yaml

  - it: should set postgresdb user environment variable when postgresql.enabled is true and postgresql.auth.username is set
    set:
      postgresql:
        enabled: true
        auth:
          username: n8npostgres
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].env
          content:
            name: DB_POSTGRESDB_USER
            value: n8npostgres
        template: statefulset-worker.yaml

  - it: should set postgresdb user environment variable when postgresql.enabled is false and externalPostgresql.username is set
    set:
      db:
        type: postgresdb
      postgresql:
        enabled: false
      externalPostgresql:
          username: n8npostgres
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].env
          content:
            name: DB_POSTGRESDB_USER
            value: n8npostgres
        template: statefulset-worker.yaml

  - it: should set postgresdb password environment variable from secret with key password when postgresql.enabled is true and postgresql.auth.password is set
    set:
      db:
        type: postgresdb
      postgresql:
        enabled: true
        auth:
          username: n8npostgres
          password: n8npostgrespassword
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].env
          content:
            name: DB_POSTGRESDB_PASSWORD
            valueFrom:
              secretKeyRef:
                name: n8n-postgresql
                key: password
                optional: true
        template: statefulset-worker.yaml

  - it: should set postgresdb password environment variable from secret with key postgres-password when postgresql.auth.username is not set
    set:
      db:
        type: postgresdb
      postgresql:
        enabled: true
        auth:
          username: ""
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].env
          content:
            name: DB_POSTGRESDB_PASSWORD
            valueFrom:
              secretKeyRef:
                name: n8n-postgresql
                key: postgres-password
                optional: true
        template: statefulset-worker.yaml

  - it: should set postgresdb password environment variable from secret with key postgres-password and with externalPostgresql.existingSecret when externalPostgresql.existingSecret is set
    set:
      db:
        type: postgresdb
      externalPostgresql:
        existingSecret: custom-secret
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].env
          content:
            name: DB_POSTGRESDB_PASSWORD
            valueFrom:
              secretKeyRef:
                name: custom-secret
                key: postgres-password
                optional: true
        template: statefulset-worker.yaml

  - it: should set redis username environment variable from secret
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].env
          content:
            name: QUEUE_BULL_REDIS_USERNAME
            valueFrom:
              secretKeyRef:
                name: n8n-redis
                key: redis-username
                optional: true
        template: statefulset-worker.yaml

  - it: should set redis username environment variable from external secret when externalRedis.existingSecret is set
    set:
      externalRedis:
        existingSecret: custom-secret
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].env
          content:
            name: QUEUE_BULL_REDIS_USERNAME
            valueFrom:
              secretKeyRef:
                name: custom-secret
                key: redis-username
                optional: true
        template: statefulset-worker.yaml

  - it: should set redis password environment variable from secret
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].env
          content:
            name: QUEUE_BULL_REDIS_PASSWORD
            valueFrom:
              secretKeyRef:
                name: n8n-redis
                key: redis-password
                optional: true
        template: statefulset-worker.yaml

  - it: should set redis password environment variable from external secret when externalRedis.existingSecret is set
    set:
      externalRedis:
        existingSecret: custom-secret
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].env
          content:
            name: QUEUE_BULL_REDIS_PASSWORD
            valueFrom:
              secretKeyRef:
                name: custom-secret
                key: redis-password
                optional: true
        template: statefulset-worker.yaml

  - it: should set extra environment variables when extraEnvVars is set
    set:
      extraEnvVars:
        N8N_EXTRA_ENV_VAR: n8nextraenvvar
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].env
          content:
            name: N8N_EXTRA_ENV_VAR
            value: n8nextraenvvar
        template: statefulset-worker.yaml

  - it: should set extra environment variables when worker.extraEnvVars is set
    set:
      worker:
        extraEnvVars:
          N8N_EXTRA_ENV_VAR: n8nextraenvvar
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].env
          content:
            name: N8N_EXTRA_ENV_VAR
            value: n8nextraenvvar
        template: statefulset-worker.yaml

  - it: should set database configurations from database configmap
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].envFrom
          content:
            configMapRef:
              name: n8n-database-configmap
        template: statefulset-worker.yaml

  - it: should set logging configurations from logging configmap
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].envFrom
          content:
            configMapRef:
              name: n8n-logging-configmap
        template: statefulset-worker.yaml

  - it: should set diagnostics configurations from diagnostics configmap
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].envFrom
          content:
            configMapRef:
              name: n8n-diagnostics-configmap
        template: statefulset-worker.yaml

  - it: should set version notifications configurations from version notifications configmap
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].envFrom
          content:
            configMapRef:
              name: n8n-version-notifications-configmap
        template: statefulset-worker.yaml

  - it: should set public api configurations from public api configmap
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].envFrom
          content:
            configMapRef:
              name: n8n-public-api-configmap
        template: statefulset-worker.yaml

  - it: should set queue configurations from queue configmap
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].envFrom
          content:
            configMapRef:
              name: n8n-queue-configmap
        template: statefulset-worker.yaml

  - it: should set task broker configurations from task broker configmap
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].envFrom
          content:
            configMapRef:
              name: n8n-task-broker-configmap
        template: statefulset-worker.yaml

  - it: should set metrics configurations from metrics configmap
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].envFrom
          content:
            configMapRef:
              name: n8n-metrics-configmap
        template: statefulset-worker.yaml

  - it: should set encryption key from encryption key secret
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].envFrom
          content:
            secretRef:
              name: n8n-encryption-key-secret-v2
        template: statefulset-worker.yaml

  - it: should set extra secret names for envFrom when extraSecretNamesForEnvFrom is set
    set:
      extraSecretNamesForEnvFrom:
        - secret1
        - secret2
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].envFrom
          content:
            secretRef:
              name: secret1
        template: statefulset-worker.yaml
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].envFrom
          content:
            secretRef:
              name: secret2
        template: statefulset-worker.yaml

  - it: should set extra secret names for envFrom when worker.extraSecretNamesForEnvFrom is set
    set:
      worker:
        extraSecretNamesForEnvFrom:
          - secret1
          - secret2
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].envFrom
          content:
            secretRef:
              name: secret1
        template: statefulset-worker.yaml
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].envFrom
          content:
            secretRef:
              name: secret2
        template: statefulset-worker.yaml

  - it: should set extra volume mounts when volumeMounts is set
    set:
      volumeMounts:
        - name: fake-volume
          mountPath: /fake-path
          readOnly: true
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].volumeMounts
          content:
            name: fake-volume
            mountPath: /fake-path
            readOnly: true
        template: statefulset-worker.yaml

  - it: should set extra volume mounts when worker.volumeMounts is set
    set:
      worker:
        volumeMounts:
          - name: fake-volume
            mountPath: /fake-path
            readOnly: true
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].volumeMounts
          content:
            name: fake-volume
            mountPath: /fake-path
            readOnly: true
        template: statefulset-worker.yaml

  - it: should set extra volumes when volumes is set
    set:
      volumes:
        - name: foo
          secret:
            secretName: mysecret
            optional: false
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: foo
            secret:
              secretName: mysecret
              optional: false
        template: statefulset-worker.yaml

  - it: should set extra volumes when worker.volumes is set
    set:
      worker:
        volumes:
          - name: foo
            secret:
              secretName: mysecret
              optional: false
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: foo
            secret:
              secretName: mysecret
              optional: false
        template: statefulset-worker.yaml

  - it: should use private npm registry when only npmRegistry.enabled is true
    set:
      npmRegistry:
        enabled: true
        url: "https://my-registry.com"
        secretName: "n8n-npm-registry-secret"
        secretKey: "npmrc"
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: npmrc
            secret:
              optional: true
              secretName: n8n-npm-registry-secret
          any: true
        template: statefulset-worker.yaml

  - it: should set node selector when nodeSelector is set
    set:
      nodeSelector:
        disktype: ssd
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector.disktype
          value: ssd
        template: statefulset-worker.yaml

  - it: should set affinity when affinity is set
    set:
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 1
              preference:
                matchExpressions:
                  - key: disktype
                    operator: In
                    values:
                      - ssd
    asserts:
      - contains:
          path: spec.template.spec.affinity.nodeAffinity.preferredDuringSchedulingIgnoredDuringExecution
          content:
            weight: 1
            preference:
              matchExpressions:
                - key: disktype
                  operator: In
                  values:
                    - ssd
        template: statefulset-worker.yaml

  - it: should set affinity when worker.affinity is set
    set:
      worker:
        affinity:
          podAntiAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  app.kubernetes.io/instance: n8n
                  app.kubernetes.io/name: n8n-worker
                  app.kubernetes.io/component: worker
              topologyKey: kubernetes.io/hostname
    asserts:
      - contains:
          path: spec.template.spec.affinity.podAntiAffinity.requiredDuringSchedulingIgnoredDuringExecution
          content:
            labelSelector:
              matchLabels:
                app.kubernetes.io/instance: n8n
                app.kubernetes.io/name: n8n-worker
                app.kubernetes.io/component: worker
            topologyKey: kubernetes.io/hostname
        template: statefulset-worker.yaml

  - it: should set tolerations when tolerations are set
    set:
      tolerations:
        - key: fake-key
          operator: fake-operator
          value: fake-value
    asserts:
      - contains:
          path: spec.template.spec.tolerations
          content:
            key: fake-key
            operator: fake-operator
            value: fake-value
        template: statefulset-worker.yaml

  - it: should set task runner container when taskRunners.mode is external
    set:
      taskRunners:
        mode: external
        external:
          port: 1234
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 200m
              memory: 256Mi
    asserts:
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-task-runners")].image
          value: n8nio/n8n:1.0.0
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-task-runners")].imagePullPolicy
          value: IfNotPresent
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-task-runners")].command
          value: ["/usr/local/bin/task-runner-launcher"]
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-task-runners")].args
          value: ["javascript"]
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-task-runners")].ports[0].containerPort
          value: 1234
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-task-runners")].ports[0].protocol
          value: TCP
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-task-runners")].livenessProbe.httpGet.path
          value: /healthz
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-task-runners")].livenessProbe.httpGet.port
          value: http
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-task-runners")].readinessProbe.httpGet.path
          value: /healthz
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-task-runners")].readinessProbe.httpGet.port
          value: http
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-task-runners")].resources
          value:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 200m
              memory: 256Mi
        template: statefulset-worker.yaml
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-task-runners")].env
          content:
            name: N8N_RUNNERS_AUTH_TOKEN
            valueFrom:
              secretKeyRef:
                name: n8n-task-runners-secret
                key: worker-auth-token
        template: statefulset-worker.yaml
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-task-runners")].envFrom
          content:
            configMapRef:
              name: n8n-task-runners-configmap
        template: statefulset-worker.yaml

  - it: should use license configmap and secret when license.enabled is true
    set:
      license:
        enabled: true
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].envFrom
          content:
            configMapRef:
              name: n8n-license-configmap
        template: statefulset-worker.yaml
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].envFrom
          content:
            secretRef:
              name: n8n-license-activation-key
        template: statefulset-worker.yaml

  - it: should set aws access key id from s3 object when binaryData.mode is s3 and minio is not enabled
    set:
      minio:
        enabled: false
      binaryData:
        availableModes:
          - filesystem
          - s3
        mode: s3
        s3:
          accessKey: fake-access-key-id
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].env
          content:
            name: N8N_EXTERNAL_STORAGE_S3_ACCESS_KEY
            valueFrom:
              secretKeyRef:
                key: access-key-id
                name: n8n-s3-secret
        template: statefulset-worker.yaml

  - it: should set aws access key from rootUser key when binaryData.mode is s3 and minio is enabled and users are not set
    set:
      binaryData:
        availableModes:
          - filesystem
          - s3
        mode: s3
      minio:
        enabled: true
        users: []
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].env
          content:
            name: N8N_EXTERNAL_STORAGE_S3_ACCESS_KEY
            valueFrom:
              secretKeyRef:
                key: rootUser
                name: n8n-minio
        template: statefulset-worker.yaml

  - it: should set aws access key from existing secret when binaryData.mode is s3 and minio is not enabled
    set:
      binaryData:
        availableModes:
          - filesystem
          - s3
        mode: s3
        s3:
          existingSecret: fake-existing-secret
      minio:
        enabled: false
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].env
          content:
            name: N8N_EXTERNAL_STORAGE_S3_ACCESS_KEY
            valueFrom:
              secretKeyRef:
                key: access-key-id
                name: fake-existing-secret
        template: statefulset-worker.yaml

  - it: should set aws secret access key from s3 object when binaryData.mode is s3 and minio is not enabled
    set:
      minio:
        enabled: false
      binaryData:
        availableModes:
          - filesystem
          - s3
        mode: s3
        s3:
          accessSecret: fake-secret-access-key
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].env
          content:
            name: N8N_EXTERNAL_STORAGE_S3_ACCESS_SECRET
            valueFrom:
              secretKeyRef:
                key: secret-access-key
                name: n8n-s3-secret
        template: statefulset-worker.yaml

  - it: should set aws secret access key from rootPassword key when binaryData.mode is s3 and minio is enabled and users are not set
    set:
      binaryData:
        availableModes:
          - filesystem
          - s3
        mode: s3
      minio:
        enabled: true
        users: []
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].env
          content:
            name: N8N_EXTERNAL_STORAGE_S3_ACCESS_SECRET
            valueFrom:
              secretKeyRef:
                key: rootPassword
                name: n8n-minio
        template: statefulset-worker.yaml

  - it: should set aws secret access key from existing secret when binaryData.mode is s3 and minio is not enabled
    set:
      binaryData:
        availableModes:
          - filesystem
          - s3
        mode: s3
        s3:
          existingSecret: fake-existing-secret
      minio:
        enabled: false
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].env
          content:
            name: N8N_EXTERNAL_STORAGE_S3_ACCESS_SECRET
            valueFrom:
              secretKeyRef:
                key: secret-access-key
                name: fake-existing-secret
        template: statefulset-worker.yaml

  - it: should set npm install init container with mount to internal task runner when nodes.external.packages is set and taskRunners.mode is internal
    set:
      taskRunners:
        mode: internal
      nodes:
        external:
          packages:
            - "moment@2.29.4"
    asserts:
      - contains:
          path: spec.template.spec.initContainers[?(@.name == "npm-install")].volumeMounts
          content:
            name: node-modules
            mountPath: "/npmdata"
            readOnly: false
          any: true
        template: statefulset-worker.yaml
      - contains:
          path: spec.template.spec.initContainers[?(@.name == "npm-install")].volumeMounts
          content:
            name: community-node-modules
            mountPath: "/nodesdata/nodes"
            readOnly: false
          any: true
        template: statefulset-worker.yaml
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].volumeMounts
          content:
            name: node-modules
            mountPath: "/home/node/.n8n"
            readOnly: false
          any: true
        template: statefulset-worker.yaml
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].env
          content:
            name: NODE_FUNCTION_ALLOW_EXTERNAL
            value: "moment"
          any: true
        template: statefulset-worker.yaml

  - it: should allow builtin node functions in internal task runner when nodes.builtin.modules is set and taskRunners.mode is internal
    set:
      taskRunners:
        mode: internal
      nodes:
        builtin:
          enabled: true
          modules:
            - "fs"
            - "crypto"
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].env
          content:
            name: NODE_FUNCTION_ALLOW_BUILTIN
            value: "fs,crypto"
          any: true
        template: statefulset-worker.yaml

  - it: should allow all builtin node functions in internal task runner when nodes.builtin.modules is enabled and taskRunners.mode is internal
    set:
      taskRunners:
        mode: internal
      nodes:
        builtin:
          enabled: true
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].env
          content:
            name: NODE_FUNCTION_ALLOW_BUILTIN
            value: "*"
          any: true
        template: statefulset-worker.yaml

  - it: should set npm install init container with mount to external task runner when nodes.external.packages is set and taskRunners.mode is external
    set:
      taskRunners:
        mode: external
      nodes:
        external:
          packages:
            - "moment@2.29.4"
    asserts:
      - contains:
          path: spec.template.spec.initContainers[?(@.name == "npm-install")].volumeMounts
          content:
            name: node-modules
            mountPath: "/npmdata"
            readOnly: false
          any: true
        template: statefulset-worker.yaml
      - contains:
          path: spec.template.spec.initContainers[?(@.name == "npm-install")].volumeMounts
          content:
            name: community-node-modules
            mountPath: "/nodesdata/nodes"
            readOnly: false
          any: true
        template: statefulset-worker.yaml
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-task-runners")].volumeMounts
          content:
            name: node-modules
            mountPath: "/home/node/.n8n"
            readOnly: false
          any: true
        template: statefulset-worker.yaml
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-task-runners")].env
          content:
            name: NODE_FUNCTION_ALLOW_EXTERNAL
            value: "moment"
          any: true
        template: statefulset-worker.yaml

  - it: should allow all external npm packages when nodes.external.allowAll is true and taskRunners.mode is internal
    set:
      taskRunners:
        mode: internal
      nodes:
        external:
          allowAll: true
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].env
          content:
            name: NODE_FUNCTION_ALLOW_EXTERNAL
            value: "*"
          any: true
        template: statefulset-worker.yaml

  - it: should allow all external npm packages for external task runner when nodes.external.allowAll is true and taskRunners.mode is external
    set:
      taskRunners:
        mode: external
      nodes:
        external:
          allowAll: true
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-task-runners")].env
          content:
            name: NODE_FUNCTION_ALLOW_EXTERNAL
            value: "*"
          any: true
        template: statefulset-worker.yaml

  - it: should allow builtin node functions in internal task runner when nodes.builtin.modules is set and taskRunners.mode is external
    set:
      taskRunners:
        mode: external
      nodes:
        builtin:
          enabled: true
          modules:
            - "fs"
            - "crypto"
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-task-runners")].env
          content:
            name: NODE_FUNCTION_ALLOW_BUILTIN
            value: "fs,crypto"
          any: true
        template: statefulset-worker.yaml

  - it: should only keep npm packages and not community packages when nodes.external.packages is set and taskRunners.mode is internal
    set:
      taskRunners:
        mode: internal
      nodes:
        external:
          packages:
            - "moment@2.29.4"
            - "n8n-nodes-python@0.1.4"
            - "n8n-nodes-chatwoot@0.1.40"
    asserts:
      - equal:
          path: spec.template.spec.initContainers[?(@.name == "npm-install")].args[0]
          value: |
            export PACKAGES="moment@2.29.4 n8n-nodes-python@0.1.4 n8n-nodes-chatwoot@0.1.40"
            export COMMUNITY_PACKAGES="n8n-nodes-python@0.1.4 n8n-nodes-chatwoot@0.1.40"
            export NON_COMMUNITY_PACKAGES="moment@2.29.4"
            echo "$PACKAGES" | sha256sum > /npmdata/packages.hash.new
            if [ ! -f /npmdata/packages.hash ] || ! cmp /npmdata/packages.hash /npmdata/packages.hash.new; then
              if [ -n "$NON_COMMUNITY_PACKAGES" ]; then
                npm install --loglevel info --no-save $NON_COMMUNITY_PACKAGES --prefix /npmdata
              fi
              if [ -n "$COMMUNITY_PACKAGES" ]; then
                npm install --loglevel info --no-save $COMMUNITY_PACKAGES --prefix /nodesdata/nodes
              fi
              mv /npmdata/packages.hash.new /npmdata/packages.hash
            else
              rm /npmdata/packages.hash.new
            fi
        template: statefulset-worker.yaml
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].env
          content:
            name: NODE_FUNCTION_ALLOW_EXTERNAL
            value: "moment"
          any: true
        template: statefulset-worker.yaml

  - it: should allow all builtin node functions in external task runner when nodes.builtin.modules is enabled and taskRunners.mode is external
    set:
      taskRunners:
        mode: external
      nodes:
        builtin:
          enabled: true
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-task-runners")].env
          content:
            name: NODE_FUNCTION_ALLOW_BUILTIN
            value: "*"
          any: true
        template: statefulset-worker.yaml

  - it: should reinstall missing packages when nodes.external.reinstallMissingPackages is true and taskRunners.mode is internal
    set:
      taskRunners:
        mode: internal
      nodes:
        external:
          reinstallMissingPackages: true
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].env
          content:
            name: N8N_REINSTALL_MISSING_PACKAGES
            value: "true"
          any: true
        template: statefulset-worker.yaml

  - it: should reinstall missing packages when nodes.external.reinstallMissingPackages is true and taskRunners.mode is external
    set:
      taskRunners:
        mode: external
      nodes:
        external:
          reinstallMissingPackages: true
    asserts:
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-task-runners")].env
          content:
            name: N8N_REINSTALL_MISSING_PACKAGES
            value: "true"
          any: true
        template: statefulset-worker.yaml

  - it: should use private npm registry when npmRegistry.enabled is true and external packages are set
    set:
      nodes:
        external:
          packages:
            - "@mycompany/custom-n8n-functions@1.0.0"
      npmRegistry:
        enabled: true
        url: "https://my-registry.com"
        secretName: "n8n-npm-registry-secret"
        secretKey: "npmrc"
    asserts:
      - contains:
          path: spec.template.spec.initContainers[?(@.name == "npm-install")].volumeMounts
          content:
            name: npmrc
            mountPath: "/home/node/.npmrc"
            subPath: "npmrc"
            readOnly: true
          any: true
        template: statefulset-worker.yaml
      - contains:
          path: spec.template.spec.initContainers[?(@.name == "npm-install")].volumeMounts
          content:
            name: node-modules
            mountPath: "/npmdata"
            readOnly: false
          any: true
        template: statefulset-worker.yaml
      - contains:
          path: spec.template.spec.initContainers[?(@.name == "npm-install")].volumeMounts
          content:
            name: community-node-modules
            mountPath: "/nodesdata/nodes"
            readOnly: false
          any: true
        template: statefulset-worker.yaml
      - contains:
          path: spec.template.spec.volumes
          content:
            name: npmrc
            secret:
              optional: true
              secretName: n8n-npm-registry-secret
          any: true
        template: statefulset-worker.yaml

  - it: should use init container to wait main node ready when worker.waitMainNodeReady.enabled is true
    set:
      worker:
        waitMainNodeReady:
          enabled: true
    asserts:
      - contains:
          path: spec.template.spec.initContainers
          content:
            name: wait-for-main
            image: busybox:1.36
          any: true
        template: statefulset-worker.yaml

  - it: should use init container to wait main node ready with http schema when overwriteSchema is not set
    set:
      worker:
        waitMainNodeReady:
          enabled: true
    asserts:
      - equal:
          path: spec.template.spec.initContainers[?(@.name == "wait-for-main")].args[0]
          value: |
            until wget -q --spider http://n8n.n8n.svc.cluster.local:5678/healthz; do
              echo "Waiting for main node to be ready..."
              sleep 2
            done
        template: statefulset-worker.yaml

  - it: should use init container to wait main node ready from main N8N_PROTOCOL environment variable when overwriteSchema is not set
    set:
      main:
        extraEnvVars:
          N8N_PROTOCOL: https
      worker:
        waitMainNodeReady:
          enabled: true
    asserts:
      - equal:
          path: spec.template.spec.initContainers[?(@.name == "wait-for-main")].args[0]
          value: |
            until wget -q --spider https://n8n.n8n.svc.cluster.local:5678/healthz; do
              echo "Waiting for main node to be ready..."
              sleep 2
            done
        template: statefulset-worker.yaml

  - it: should use init container to wait main node ready with https schema when overwriteSchema is set https
    set:
      worker:
        waitMainNodeReady:
          enabled: true
          overwriteSchema: https
    asserts:
      - equal:
          path: spec.template.spec.initContainers[?(@.name == "wait-for-main")].args[0]
          value: |
            until wget -q --spider https://n8n.n8n.svc.cluster.local:5678/healthz; do
              echo "Waiting for main node to be ready..."
              sleep 2
            done
        template: statefulset-worker.yaml

  - it: should use init container to wait main node ready with different service name when overwriteUrl is set
    set:
      worker:
        waitMainNodeReady:
          enabled: true
          overwriteUrl: "n8n-different-name.n8n.svc.cluster.local:1234"
    asserts:
      - equal:
          path: spec.template.spec.initContainers[?(@.name == "wait-for-main")].args[0]
          value: |
            until wget -q --spider http://n8n-different-name.n8n.svc.cluster.local:1234/healthz; do
              echo "Waiting for main node to be ready..."
              sleep 2
            done
        template: statefulset-worker.yaml

  - it: should use init container to wait main node ready with different health check path when healthCheckPath is set different
    set:
      worker:
        waitMainNodeReady:
          enabled: true
          healthCheckPath: "/healthz-different"
    asserts:
      - equal:
          path: spec.template.spec.initContainers[?(@.name == "wait-for-main")].args[0]
          value: |
            until wget -q --spider http://n8n.n8n.svc.cluster.local:5678/healthz-different; do
              echo "Waiting for main node to be ready..."
              sleep 2
            done
        template: statefulset-worker.yaml

  - it: should use init container to wait main node ready with parameters when additionalParameters is set
    set:
      main:
        extraEnvVars:
          N8N_PROTOCOL: https
      worker:
        waitMainNodeReady:
          enabled: true
          additionalParameters:
            - "--no-check-certificate"
    asserts:
      - equal:
          path: spec.template.spec.initContainers[?(@.name == "wait-for-main")].args[0]
          value: |
            until wget -q --spider --no-check-certificate https://n8n.n8n.svc.cluster.local:5678/healthz; do
              echo "Waiting for main node to be ready..."
              sleep 2
            done
        template: statefulset-worker.yaml

  - it: should use startupProbe to wait n8n process ready
    asserts:
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].startupProbe.exec.command
          value: ["/bin/sh", "-c", "ps aux | grep '[n]8n'"]
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].startupProbe.initialDelaySeconds
          value: 10
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].startupProbe.periodSeconds
          value: 5
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].startupProbe.failureThreshold
          value: 30
        template: statefulset-worker.yaml

  - it: should add init container to worker pod when worker.initContainers is defined
    set:
      worker:
        initContainers:
          - name: my-init-container
            image: "my-image:1.0.0"
            imagePullPolicy: IfNotPresent
            command:
              - sleep
              - infinity
    asserts:
      - equal:
          path: spec.template.spec.initContainers[?(@.name == "my-init-container")].name
          value: my-init-container
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.initContainers[?(@.name == "my-init-container")].image
          value: "my-image:1.0.0"
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.initContainers[?(@.name == "my-init-container")].imagePullPolicy
          value: IfNotPresent
        template: statefulset-worker.yaml
      - equal:
          path: spec.template.spec.initContainers[?(@.name == "my-init-container")].command
          value:
            - sleep
            - infinity
        template: statefulset-worker.yaml

  - it: should add extra containers to worker pod when worker.extraContainers is defined
    set:
      worker:
        extraContainers:
          - name: my-extra-container
            image: "my-image:1.0.0"
            imagePullPolicy: IfNotPresent
            command:
              - sleep
              - infinity
    asserts:
      - contains:
          path: spec.template.spec.containers
          content:
            name: my-extra-container
            image: "my-image:1.0.0"
            imagePullPolicy: IfNotPresent
            command:
              - sleep
              - infinity
          any: true
        template: statefulset-worker.yaml

  - it: should set dnsPolicy when dnsPolicy is set
    set:
      dnsPolicy: ClusterFirst
    asserts:
      - equal:
          path: spec.template.spec.dnsPolicy
          value: ClusterFirst
        template: statefulset-worker.yaml

  - it: should set dnsConfig when dnsConfig is set
    set:
      dnsConfig:
        nameservers:
          - 1.1.1.1
          - 1.0.0.1
    asserts:
      - contains:
          path: spec.template.spec.dnsConfig.nameservers
          content:
            1.1.1.1
          any: true
        template: statefulset-worker.yaml
      - contains:
          path: spec.template.spec.dnsConfig.nameservers
          content:
            1.0.0.1
          any: true
        template: statefulset-worker.yaml

  - it: should set dnsPolicy and dnsConfig when dnsPolicy and dnsConfig are set
    set:
      dnsPolicy: None
      dnsConfig:
        nameservers:
          - 1.1.1.1
          - 1.0.0.1
    asserts:
      - equal:
          path: spec.template.spec.dnsPolicy
          value: None
        template: statefulset-worker.yaml
      - contains:
          path: spec.template.spec.dnsConfig.nameservers
          content:
            1.1.1.1
          any: true
        template: statefulset-worker.yaml
      - contains:
          path: spec.template.spec.dnsConfig.nameservers
          content:
            1.0.0.1
          any: true
        template: statefulset-worker.yaml

  - it: should add hostAliases to worker pod when worker.hostAliases is defined
    set:
      worker:
        hostAliases:
          - ip: 1.1.1.1
            hostnames:
              - "my-host.com"
    asserts:
      - contains:
          path: spec.template.spec.hostAliases
          content:
            ip: 1.1.1.1
            hostnames:
              - "my-host.com"
          any: true
        template: statefulset-worker.yaml

  - it: should use volume name when volumeName is set and taskRunners.mode is internal
    set:
      nodes:
        external:
          packages:
            - fake-package
      worker:
        persistence:
          enabled: true
          volumeName: fake-volume-name
      taskRunners:
        mode: internal
    asserts:
      - contains:
          path: spec.template.spec.initContainers[?(@.name == "npm-install")].volumeMounts
          content:
            name: fake-volume-name
            mountPath: /npmdata
            readOnly: false
          any: true
        template: statefulset-worker.yaml
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-worker")].volumeMounts
          content:
            name: fake-volume-name
            mountPath: /home/node/.n8n
            readOnly: false
          any: true
        template: statefulset-worker.yaml
      - equal:
          path: spec.volumeClaimTemplates[?(@.metadata.name == "fake-volume-name")].metadata.name
          value: fake-volume-name
        template: statefulset-worker.yaml

  - it: should use volume name when volumeName is set and taskRunners.mode is external
    set:
      nodes:
        external:
          packages:
            - fake-package
      worker:
        persistence:
          enabled: true
          volumeName: fake-volume-name
      taskRunners:
        mode: external
    asserts:
      - contains:
          path: spec.template.spec.initContainers[?(@.name == "npm-install")].volumeMounts
          content:
            name: fake-volume-name
            mountPath: /npmdata
            readOnly: false
          any: true
        template: statefulset-worker.yaml
      - contains:
          path: spec.template.spec.containers[?(@.name == "n8n-task-runners")].volumeMounts
          content:
            name: fake-volume-name
            mountPath: /home/node/.n8n
            readOnly: false
          any: true
        template: statefulset-worker.yaml
      - equal:
          path: spec.volumeClaimTemplates[?(@.metadata.name == "fake-volume-name")].metadata.name
          value: fake-volume-name
        template: statefulset-worker.yaml

  - it: should set runtimeClassName when worker.runtimeClassName is defined
    set:
      worker:
        runtimeClassName: "my-runtime-class"
    asserts:
      - equal:
          path: spec.template.spec.runtimeClassName
          value: my-runtime-class
        template: statefulset-worker.yaml

  - it: should match snapshot of default values
    release:
      name: n8n
      namespace: n8n
    chart:
      version: 1.0.0
      appVersion: 1.0.0
    set:
      encryptionKey: "test-encryption-key"
    asserts:
      - matchSnapshot: { }

  - it: should match snapshot of worker persistence
    release:
      name: n8n
      namespace: n8n
    chart:
      version: 1.0.0
      appVersion: 1.0.0
    set:
      encryptionKey: "test-encryption-key"
      worker:
        count: 1
        persistence:
          enabled: true
    asserts:
      - matchSnapshot: { }
